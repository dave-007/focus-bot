---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - src/config.ts
  - src/bot/middleware/auth.ts
  - .env.example
autonomous: true
user_setup:
  - service: telegram
    why: "Bot token and user ID for authentication"
    env_vars:
      - name: TELEGRAM_BOT_TOKEN
        source: "Message @BotFather on Telegram, send /newbot, copy the token"
      - name: ALLOWED_USER_IDS
        source: "Message @userinfobot on Telegram to get your user ID"
      - name: NOTES_DIR
        source: "Absolute path to your Obsidian vault (e.g., /home/user/obsidian/inbox)"

must_haves:
  truths:
    - "Bot fails fast with clear error if TELEGRAM_BOT_TOKEN is missing or empty"
    - "Bot fails fast with clear error if ALLOWED_USER_IDS is missing or invalid"
    - "Bot fails fast with clear error if NOTES_DIR is missing, not absolute, or doesn't exist"
    - "Auth middleware blocks unauthorized users with 'not authorized' message"
    - "Auth middleware passes authorized users through to handlers"
  artifacts:
    - path: "src/config.ts"
      provides: "Zod schema validation and exported config object"
      exports: ["config"]
      contains: "z.object"
    - path: "src/bot/middleware/auth.ts"
      provides: "Auth middleware function"
      exports: ["authMiddleware"]
      contains: "ALLOWED_USER_IDS"
    - path: "package.json"
      provides: "Project dependencies"
      contains: "grammy"
    - path: "tsconfig.json"
      provides: "TypeScript configuration"
      contains: "compilerOptions"
  key_links:
    - from: "src/bot/middleware/auth.ts"
      to: "src/config.ts"
      via: "imports config.ALLOWED_USER_IDS"
      pattern: "import.*config"
---

<objective>
Set up TypeScript project with Grammy dependencies, implement fail-fast config validation via Zod, and create auth middleware that blocks unauthorized users.

Purpose: Establishes the security boundary and configuration foundation that all subsequent features depend on.
Output: Working config module that validates environment variables and auth middleware ready for bot registration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize TypeScript project with Grammy dependencies</name>
  <files>package.json, tsconfig.json, .env.example</files>
  <action>
Create package.json with:
- name: "focus-bot"
- type: "module" (ESM)
- scripts: "dev": "tsx src/index.ts", "build": "tsc", "start": "node dist/index.js"
- dependencies: grammy@1.39.3, @grammyjs/runner@2.0.3, @grammyjs/auto-retry@2.0.2, zod@4.3.6, dotenv@16.5.0
- devDependencies: typescript@5.9.3, tsx@4.21.0, @types/node@22.x

Create tsconfig.json with:
- target: "ES2022"
- module: "NodeNext"
- moduleResolution: "NodeNext"
- outDir: "dist"
- rootDir: "src"
- strict: true
- esModuleInterop: true
- skipLibCheck: true

Create .env.example with commented examples:
- TELEGRAM_BOT_TOKEN=your-token-from-botfather
- ALLOWED_USER_IDS=123456789,987654321
- NOTES_DIR=/absolute/path/to/obsidian/vault

Run npm install to verify dependencies resolve.
  </action>
  <verify>npm install completes without errors; package-lock.json created; node_modules contains grammy, zod</verify>
  <done>Project initialized with all dependencies installed and TypeScript configured for ESM</done>
</task>

<task type="auto">
  <name>Task 2: Implement fail-fast config validation with Zod</name>
  <files>src/config.ts</files>
  <action>
Create src/config.ts following the exact pattern from 01-RESEARCH.md:

1. Import z from 'zod', config as loadEnv from 'dotenv', fs and path from 'node:*'
2. Call loadEnv() at module top
3. Define envSchema with z.object containing:
   - TELEGRAM_BOT_TOKEN: z.string().min(1, 'TELEGRAM_BOT_TOKEN is required')
   - ALLOWED_USER_IDS: z.string().min(1).transform(split by comma, parseInt).refine(all are positive numbers)
   - NOTES_DIR: z.string().min(1).refine(isAbsolute).refine(existsSync).refine(isDirectory)
4. Use safeParse(process.env)
5. If !parsed.success: log each issue with path and message, then process.exit(1)
6. Export const config = parsed.data
7. Export type Config = typeof config

Use .js extension in imports (ESM requirement).
  </action>
  <verify>Create a test .env with invalid values and run `npx tsx src/config.ts` - should exit with clear error messages. Then with valid values - should complete without error.</verify>
  <done>Config module validates all three env vars, exits with clear errors on invalid config, exports typed config object on success</done>
</task>

<task type="auto">
  <name>Task 3: Create auth middleware that blocks unauthorized users</name>
  <files>src/bot/middleware/auth.ts</files>
  <action>
Create src/bot/middleware/auth.ts:

1. Import Context, NextFunction from 'grammy'
2. Import config from '../../config.js' (note .js extension for ESM)
3. Export async function authMiddleware(ctx: Context, next: NextFunction): Promise<void>
4. Extract userId = ctx.from?.id
5. If !userId OR userId not in config.ALLOWED_USER_IDS:
   - await ctx.reply('You are not authorized to use this bot.')
   - return (do NOT call next())
6. If authorized: await next()

Critical: Always await next() when authorized - never just next().
  </action>
  <verify>TypeScript compiles without errors: npx tsc --noEmit</verify>
  <done>Auth middleware exported, blocks unauthorized users with message, passes authorized users through</done>
</task>

</tasks>

<verification>
1. `npm install` - completes without errors
2. `npx tsc --noEmit` - TypeScript compiles without errors
3. Create test .env with missing TELEGRAM_BOT_TOKEN, run `npx tsx src/config.ts` - exits with "TELEGRAM_BOT_TOKEN is required"
4. Create test .env with NOTES_DIR=/nonexistent, run `npx tsx src/config.ts` - exits with path error
5. All files exist at expected paths
</verification>

<success_criteria>
- package.json has correct dependencies (grammy, zod, runner)
- tsconfig.json configured for ESM
- src/config.ts exports typed config after Zod validation
- src/config.ts exits process with clear errors on invalid config
- src/bot/middleware/auth.ts exports authMiddleware function
- Auth middleware checks user ID against config.ALLOWED_USER_IDS
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
