---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/bot/handlers/command.ts
  - src/bot/bot.ts
  - src/index.ts
autonomous: false

must_haves:
  truths:
    - "Authorized user can send /start and receives help message"
    - "Bot starts successfully with valid configuration"
    - "Bot uses runner for concurrent long polling"
    - "Bot has graceful shutdown on SIGINT/SIGTERM"
    - "Unauthorized user receives rejection message (from auth middleware)"
  artifacts:
    - path: "src/bot/handlers/command.ts"
      provides: "Start command handler"
      exports: ["handleStart"]
      contains: "Welcome to Focus Bot"
    - path: "src/bot/bot.ts"
      provides: "Bot creation with middleware and handlers"
      exports: ["createBot"]
      contains: "bot.use"
    - path: "src/index.ts"
      provides: "Application entry point"
      contains: "run(bot)"
  key_links:
    - from: "src/index.ts"
      to: "src/bot/bot.ts"
      via: "imports createBot"
      pattern: "import.*createBot"
    - from: "src/bot/bot.ts"
      to: "src/bot/middleware/auth.ts"
      via: "bot.use(authMiddleware)"
      pattern: "bot\\.use\\(authMiddleware\\)"
    - from: "src/bot/bot.ts"
      to: "src/bot/handlers/command.ts"
      via: "bot.command('start', handleStart)"
      pattern: "bot\\.command.*start"
---

<objective>
Create /start command handler, assemble bot with middleware chain (auth first), and create entry point with runner for concurrent long polling and graceful shutdown.

Purpose: Completes the foundation phase by wiring all components into a running bot that validates config, enforces auth, and responds to /start.
Output: Fully functional bot that can be started with `npm run dev` and tested via Telegram.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /start command handler</name>
  <files>src/bot/handlers/command.ts</files>
  <action>
Create src/bot/handlers/command.ts:

1. Import Context from 'grammy'
2. Export async function handleStart(ctx: Context): Promise<void>
3. Define help message (multiline template literal):

```
Welcome to Focus Bot!

I capture your thoughts and save them as notes in your Obsidian vault.

How to use:
- Just send me any text message
- I'll generate a title and tags automatically
- The note will be saved to your vault

Commands:
/start - Show this help message
```

4. await ctx.reply(helpMessage)
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>handleStart function exported, sends help message explaining bot usage</done>
</task>

<task type="auto">
  <name>Task 2: Assemble bot with middleware chain and handlers</name>
  <files>src/bot/bot.ts, src/index.ts</files>
  <action>
Create src/bot/bot.ts:

1. Import Bot from 'grammy'
2. Import autoRetry from '@grammyjs/auto-retry'
3. Import config from '../config.js'
4. Import authMiddleware from './middleware/auth.js'
5. Import handleStart from './handlers/command.js'

6. Export function createBot(): Bot:
   - const bot = new Bot(config.TELEGRAM_BOT_TOKEN)
   - bot.api.config.use(autoRetry({ maxRetryAttempts: 5, maxDelaySeconds: 60 }))
   - bot.use(authMiddleware)  // MUST be first middleware
   - bot.command('start', handleStart)
   - bot.catch((err) => { console.error with update_id and error })
   - return bot

Create src/index.ts:

1. Import run from '@grammyjs/runner'
2. Import createBot from './bot/bot.js'

3. async function main():
   - const bot = createBot()
   - const handle = run(bot)
   - Define shutdown handler: logs, await handle.stop(), process.exit(0)
   - process.on('SIGINT', shutdown)
   - process.on('SIGTERM', shutdown)
   - console.log('Bot is running...')
   - await handle.task()

4. main().catch((err) => { console.error(err); process.exit(1); })

Critical middleware order: auth MUST be registered before any command handlers.
  </action>
  <verify>
1. npx tsc --noEmit - TypeScript compiles
2. Create valid .env file, run npm run dev - bot starts without error
3. Ctrl+C should log "Shutting down..." and exit cleanly
  </verify>
  <done>Bot created with auth middleware first, /start command registered, entry point uses runner with graceful shutdown</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete foundation bot: config validation, auth middleware, /start command, runner with graceful shutdown</what-built>
  <how-to-verify>
1. Create .env file with your credentials:
   - TELEGRAM_BOT_TOKEN=your-token
   - ALLOWED_USER_IDS=your-telegram-id
   - NOTES_DIR=/path/to/existing/directory

2. Run: npm run dev
   - Expected: "Bot is running..." logged

3. Send /start to your bot on Telegram
   - Expected: Help message received

4. (Optional) Test unauthorized user:
   - Temporarily remove your ID from ALLOWED_USER_IDS
   - Send any message
   - Expected: "You are not authorized to use this bot."

5. Press Ctrl+C in terminal
   - Expected: "Shutting down gracefully..." then clean exit
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run dev` starts bot without errors
2. /start command returns help message to authorized user
3. Unauthorized user receives rejection message
4. Ctrl+C triggers graceful shutdown
5. Missing/invalid .env causes clear error message and exit
</verification>

<success_criteria>
- src/bot/handlers/command.ts exports handleStart function
- src/bot/bot.ts exports createBot function
- src/bot/bot.ts registers authMiddleware BEFORE command handlers
- src/index.ts uses run() from @grammyjs/runner
- src/index.ts handles SIGINT/SIGTERM for graceful shutdown
- Bot responds to /start with help message
- Bot rejects unauthorized users
- All Phase 1 success criteria from ROADMAP.md are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
